name: Check checklist in PR

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  check-checklist:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # Wait 15 seconds so that the job doesn't run immediately when checking off multiple items in the checklist.
      # - name: Wait for 15 seconds
      #   run: |
      #     sleep 15

    - name: Check checklist in PR description
      id: check_checklist
      run: |
        DESCRIPTION=$(jq -r .pull_request.body < $GITHUB_EVENT_PATH)
        UNCHECKED_ITEMS=$(echo "$DESCRIPTION" | grep -o '\[ \]' || true)
        if [ -z "$UNCHECKED_ITEMS" ]; then
          echo "all_checked=true" >> $GITHUB_ENV
        else
          echo "all_checked=false" >> $GITHUB_ENV
          echo "unchecked_items=$UNCHECKED_ITEMS" >> $GITHUB_ENV
        fi

    - name: Leave a comment
      if: steps.check_checklist.outputs.all_checked == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: "All items in the checklist have been checkedðŸŽ‰"
          })

    - name: Leave a comment with unchecked items
      if: steps.check_checklist.outputs.all_checked == 'false'
      uses: actions/github-script@v6
      with:
        script: |
          uncheckedItems = process.env.unchecked_items.split('\n').map(item => `- ${item}`).join('\n');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `Not all items in the checklist have been checkedðŸ‘€\n\nPlease review the following unchecked items in the PR description:\n${uncheckedItems}`
          })
